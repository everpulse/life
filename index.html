<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحه شخصی</title>
    <style>
        /* استایل‌ها بدون تغییر باقی می‌مانند */
        /* ... (همان استایل‌های قبلی) ... */
    </style>
</head>
<body>
    <canvas id="matrix"></canvas>
    
    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <button class="admin-btn" onclick="toggleEditMode()">حالت ویرایش</button>
        <button class="admin-btn" onclick="logout()">خروج</button>
        <button class="admin-btn" onclick="saveToGist()">ذخیره در فضای ابری</button>
        <button class="admin-btn" onclick="loadFromGist()">بارگذاری از فضای ابری</button>
    </div>
    
    <!-- Edit Mode Indicator -->
    <div class="edit-indicator" id="editIndicator">حالت ویرایش فعال</div>
    
    <!-- Password Modal -->
    <div id="passwordModal" class="password-modal">
        <div class="password-content">
            <h2>ورود به پنل مدیریت</h2>
            <input type="password" id="passwordInput" class="password-input" placeholder="رمز عبور را وارد کنید">
            <br>
            <button class="admin-btn" onclick="checkPassword()">ورود</button>
            <button class="admin-btn" onclick="closePasswordModal()">انصراف</button>
        </div>
    </div>

    <!-- Gist Token Modal -->
    <div id="gistTokenModal" class="password-modal">
        <div class="password-content">
            <h2>تنظیمات GitHub API</h2>
            <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin-bottom: 15px;">
                برای ذخیره سازی آنلاین،需要一个 GitHub Personal Access Token.
                <a href="https://github.com/settings/tokens/new" target="_blank" style="color: #4af;">اینجا ایجاد کنید</a>
            </p>
            <input type="password" id="githubToken" class="password-input" placeholder="GitHub Personal Access Token">
            <input type="text" id="gistId" class="password-input" placeholder="Gist ID (خالی بگذارید اگر جدید است)">
            <br>
            <button class="admin-btn" onclick="saveGistConfig()">ذخیره تنظیمات</button>
            <button class="admin-btn" onclick="closeGistTokenModal()">انصراف</button>
        </div>
    </div>
    
    <div class="container">
        <div class="profile-section">
            <div class="profile-image" id="profileImageContainer">
                <img id="profileImg" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjMzMzIi8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNDAiIHI9IjE1IiBmaWxsPSIjNjY2Ii8+CjxwYXRoIGQ9Im0zNSA4MGMwLTE1IDEwLTI1IDI1LTI1czI1IDEwIDI1IDI1IiBmaWxsPSIjNjY2Ii8+Cjwvc3ZnPgo=" alt="Profile">
                <div class="edit-icon" id="editIcon" style="display: none;">✏️</div>
            </div>
            <input type="file" id="imageInput" accept="image/*">
            
            <div class="profile-name" id="profileName">نام شما</div>
            <div class="profile-desc" id="profileDesc">توضیح کوتاه درباره شما</div>
        </div>

        <div class="menu-items">
            <div class="menu-item" onclick="openModal('biography')">
                <h3 class="editable-title" data-type="biography">بیوگرافی</h3>
            </div>
            
            <div class="menu-item" onclick="openModal('tenrules')">
                <h3 class="editable-title" data-type="tenrules">ده فرمان</h3>
            </div>
            
            <div class="menu-item" onclick="openModal('playlist')">
                <h3 class="editable-title" data-type="playlist">پلی لیست</h3>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle"></h2>
            <div class="modal-body" id="modalBody" contenteditable="true">
                <!-- محتوا اینجا نمایش داده می‌شود -->
            </div>
        </div>
    </div>

    <script>
        // تنظیمات اولیه
        const GITHUB_GIST_FILENAME = "profile_data.json";
        let githubToken = localStorage.getItem('githubToken');
        let gistId = localStorage.getItem('gistId');
        
        // Matrix Animation (بدون تغییر)
        // ... (کدهای ماتریکس بدون تغییر باقی می‌مانند) ...
        
        // Admin system
        const ADMIN_PASSWORD = "aeon2025"; // تغییر دهید
        let isEditMode = false;

        // Double click on profile image for admin access
        let clickCount = 0;
        document.getElementById('profileImageContainer').addEventListener('click', function() {
            if (!isEditMode) {
                clickCount++;
                setTimeout(() => {
                    if (clickCount === 1) {
                        clickCount = 0;
                    } else if (clickCount === 2) {
                        showPasswordModal();
                        clickCount = 0;
                    }
                }, 400);
            } else {
                document.getElementById('imageInput').click();
            }
        });

        // ... (توابع مدیریت modal بدون تغییر) ...
        
        // Content data - حالا از localStorage بارگذاری می‌شود یا از نمونه اولیه استفاده می‌کند
        let contentData = loadContentData();

        function loadContentData() {
            const saved = localStorage.getItem('contentData');
            if (saved) {
                return JSON.parse(saved);
            } else {
                // اگر داده‌ای ذخیره نشده، از فایل data.json بارگذاری کن
                return {
                    "profileName": "Abbas",
                    "profileDesc": "توضیح کوتاه درباره شما",
                    "profileImage": "",
                    "contentData": {
                        "biography": {
                            "title": "بیوگرافی",
                            "content": "اینجا بیوگرافی خود را بنویسید...\n\nمی‌توانید درباره تحصیلات، تجربیات کاری، علایق و هر چیز دیگری که می‌خواهید بنویسید."
                        },
                        "tenrules": {
                            "title": "ده فرمان",
                            "content": "۱. فرمان اول...\n۲. فرمان دوم...\n۳. فرمان سوم...\n۴. فرمان چهارم...\n۵. فرمان پنجم...\n۶. فرمان ششم...\n۷. فرمان هفتم...\n۸. فرمان هشتم...\n۹. فرمان نهم...\n۱۰. فرمان دهم..."
                        },
                        "playlist": {
                            "title": "پلی لیست",
                            "content": "آهنگ های خود را آپلود کنید...",
                            "audioFiles": []
                        }
                    }
                };
            }
        }

        // ... (توابع مربوط به پخش صوت بدون تغییر) ...

        // توابع جدید برای مدیریت GitHub Gist
        function showGistTokenModal() {
            document.getElementById('gistTokenModal').style.display = 'block';
            document.getElementById('githubToken').value = githubToken || '';
            document.getElementById('gistId').value = gistId || '';
        }

        function closeGistTokenModal() {
            document.getElementById('gistTokenModal').style.display = 'none';
        }

        function saveGistConfig() {
            githubToken = document.getElementById('githubToken').value;
            gistId = document.getElementById('gistId').value;
            
            localStorage.setItem('githubToken', githubToken);
            localStorage.setItem('gistId', gistId);
            
            closeGistTokenModal();
            alert('تنظیمات ذخیره شد!');
        }

        async function saveToGist() {
            if (!githubToken) {
                showGistTokenModal();
                return;
            }
            
            try {
                // آماده کردن داده‌ها برای ذخیره
                const dataToSave = {
                    profileName: document.getElementById('profileName').textContent,
                    profileDesc: document.getElementById('profileDesc').textContent,
                    profileImage: document.getElementById('profileImg').src,
                    contentData: contentData
                };
                
                const response = await updateGist(dataToSave);
                if (response.id) {
                    gistId = response.id;
                    localStorage.setItem('gistId', gistId);
                    alert('داده‌ها با موفقیت در فضای ابری ذخیره شدند!');
                }
            } catch (error) {
                console.error('Error saving to Gist:', error);
                alert('خطا در ذخیره‌سازی: ' + error.message);
            }
        }

        async function loadFromGist() {
            if (!githubToken || !gistId) {
                showGistTokenModal();
                return;
            }
            
            try {
                const data = await getGistData();
                if (data) {
                    // به روز رسانی داده‌ها
                    document.getElementById('profileName').textContent = data.profileName;
                    document.getElementById('profileDesc').textContent = data.profileDesc;
                    document.getElementById('profileImg').src = data.profileImage;
                    
                    contentData = data.contentData;
                    localStorage.setItem('contentData', JSON.stringify(contentData));
                    
                    // به روز رسانی عناوین
                    document.querySelectorAll('.editable-title').forEach(title => {
                        const type = title.dataset.type;
                        if (contentData[type] && contentData[type].title) {
                            title.textContent = contentData[type].title;
                        }
                    });
                    
                    alert('داده‌ها با موفقیت از فضای ابری بارگذاری شدند!');
                }
            } catch (error) {
                console.error('Error loading from Gist:', error);
                alert('خطا در بارگذاری: ' + error.message);
            }
        }

        async function updateGist(data) {
            const url = gistId 
                ? `https://api.github.com/gists/${gistId}`
                : 'https://api.github.com/gists';
            
            const response = await fetch(url, {
                method: gistId ? 'PATCH' : 'POST',
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    description: "Profile data storage",
                    public: false,
                    files: {
                        [GITHUB_GIST_FILENAME]: {
                            content: JSON.stringify(data)
                        }
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }

        async function getGistData() {
            if (!gistId) return null;
            
            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: {
                    'Authorization': `token ${githubToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const gist = await response.json();
            const content = gist.files[GITHUB_GIST_FILENAME].content;
            return JSON.parse(content);
        }

        // در تابع saveData، localStorage را به روز کنید
        function saveData() {
            localStorage.setItem('contentData', JSON.stringify(contentData));
        }

        // بارگذاری اولیه داده‌ها
        window.addEventListener('load', function() {
            // بارگذاری از localStorage
            const savedImage = localStorage.getItem('profileImage');
            if (savedImage) {
                document.getElementById('profileImg').src = savedImage;
            }
            
            const savedName = localStorage.getItem('profileName');
            if (savedName) {
                document.getElementById('profileName').textContent = savedName;
            }
            
            const savedDesc = localStorage.getItem('profileDesc');
            if (savedDesc) {
                document.getElementById('profileDesc').textContent = savedDesc;
            }
            
            // بارگذاری محتوای ذخیره شده
            const savedContent = localStorage.getItem('contentData');
            if (savedContent) {
                contentData = JSON.parse(savedContent);
                
                // به روز رسانی عناوین در DOM
                document.querySelectorAll('.editable-title').forEach(title => {
                    const type = title.dataset.type;
                    if (contentData[type] && contentData[type].title) {
                        title.textContent = contentData[type].title;
                    }
                });
            }
            
            // اگر token ذخیره شده وجود دارد، سعی کنید از Gist بارگذاری کنید
            if (githubToken && gistId) {
                // به صورت خودکار از Gist بارگذاری کنید یا از کاربر بپرسید
                if (confirm('آیا می‌خواهید آخرین داده‌های ذخیره شده در فضای ابری را بارگذاری کنید؟')) {
                    loadFromGist();
                }
            }
        });
    </script>
</body>
</html>


